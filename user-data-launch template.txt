#!/bin/bash
set -xe

# -------------------------
# System update
# -------------------------
dnf update -y

# -------------------------
# Install required packages
# -------------------------
dnf install -y httpd php php-mysqlnd amazon-efs-utils wget

# -------------------------
# Enable & start Apache
# -------------------------
systemctl enable httpd
systemctl start httpd

# -------------------------
# Create mount directory (safe)
# -------------------------
mkdir -p /var/www/html

# -------------------------
# Mount EFS to web root
# -------------------------
mount -t efs fs-00a0542a495742795:/ /var/www/html

# Persist EFS mount
echo "fs-00a0542a495742795:/ /var/www/html efs _netdev,tls 0 0" >> /etc/fstab

# -------------------------
# Install WordPress ONLY if not present
# -------------------------
if [ ! -f /var/www/html/wp-config.php ]; then
  cd /var/www/html
  wget https://wordpress.org/latest.tar.gz
  tar -xzf latest.tar.gz
  mv wordpress/* .
  rm -rf wordpress latest.tar.gz
fi

# -------------------------
# Permissions
# -------------------------
chown -R apache:apache /var/www/html
chmod -R 755 /var/www/html

# -------------------------
# Remove Apache test page
# -------------------------
rm -f /var/www/html/index.html

# -------------------------
# Restart Apache
# -------------------------
systemctl restart httpd
